(function(){/*
 Copyright 2020 Andrew Sayers <andrew-github.com@pileofstuff.org>

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use, copy,
 modify, merge, publish, distribute, sublicense, and/or sell copies
 of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
*/
function ba(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function ca(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:ba(a)}}var da="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},ea="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,g){if(a==Array.prototype||a==Object.prototype)return a;a[b]=g.value;return a};
function fa(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var g=a[b];if(g&&g.Math==Math)return g}throw Error("Cannot find global object");}var z=fa(this);function A(a,b){if(b)a:{var g=z;a=a.split(".");for(var l=0;l<a.length-1;l++){var n=a[l];if(!(n in g))break a;g=g[n]}a=a[a.length-1];l=g[a];b=b(l);b!=l&&null!=b&&ea(g,a,{configurable:!0,writable:!0,value:b})}}var ha;
if("function"==typeof Object.setPrototypeOf)ha=Object.setPrototypeOf;else{var ia;a:{var ja={a:!0},ka={};try{ka.__proto__=ja;ia=ka.a;break a}catch(a){}ia=!1}ha=ia?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var la=ha;
function J(a,b){a.prototype=da(b.prototype);a.prototype.constructor=a;if(la)la(a,b);else for(var g in b)if("prototype"!=g)if(Object.defineProperties){var l=Object.getOwnPropertyDescriptor(b,g);l&&Object.defineProperty(a,g,l)}else a[g]=b[g];a.fa=b.prototype}
A("Symbol",function(a){function b(c){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new g(l+(c||"")+"_"+n++,c)}function g(c,d){this.g=c;ea(this,"description",{configurable:!0,writable:!0,value:d})}if(a)return a;g.prototype.toString=function(){return this.g};var l="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",n=0;return b});
A("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),g=0;g<b.length;g++){var l=z[b[g]];"function"===typeof l&&"function"!=typeof l.prototype[a]&&ea(l.prototype,a,{configurable:!0,writable:!0,value:function(){return ma(ba(this))}})}return a});function ma(a){a={next:a};a[Symbol.iterator]=function(){return this};return a}
function na(a,b){a instanceof String&&(a+="");var g=0,l=!1,n={next:function(){if(!l&&g<a.length){var c=g++;return{value:b(c,a[c]),done:!1}}l=!0;return{done:!0,value:void 0}}};n[Symbol.iterator]=function(){return n};return n}A("Array.prototype.keys",function(a){return a?a:function(){return na(this,function(b){return b})}});
var oa="function"==typeof Object.assign?Object.assign:function(a,b){for(var g=1;g<arguments.length;g++){var l=arguments[g];if(l)for(var n in l)Object.prototype.hasOwnProperty.call(l,n)&&(a[n]=l[n])}return a};A("Object.assign",function(a){return a||oa});
A("Array.from",function(a){return a?a:function(b,g,l){g=null!=g?g:function(e){return e};var n=[],c="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof c){b=c.call(b);for(var d=0;!(c=b.next()).done;)n.push(g.call(l,c.value,d++))}else for(c=b.length,d=0;d<c;d++)n.push(g.call(l,b[d],d));return n}});
A("Promise",function(a){function b(d){this.i=0;this.l=void 0;this.g=[];this.I=!1;var e=this.A();try{d(e.resolve,e.reject)}catch(p){e.reject(p)}}function g(){this.g=null}function l(d){return d instanceof b?d:new b(function(e){e(d)})}if(a)return a;g.prototype.i=function(d){if(null==this.g){this.g=[];var e=this;this.l(function(){e.B()})}this.g.push(d)};var n=z.setTimeout;g.prototype.l=function(d){n(d,0)};g.prototype.B=function(){for(;this.g&&this.g.length;){var d=this.g;this.g=[];for(var e=0;e<d.length;++e){var p=
d[e];d[e]=null;try{p()}catch(h){this.A(h)}}}this.g=null};g.prototype.A=function(d){this.l(function(){throw d;})};b.prototype.A=function(){function d(h){return function(k){p||(p=!0,h.call(e,k))}}var e=this,p=!1;return{resolve:d(this.L),reject:d(this.B)}};b.prototype.L=function(d){if(d===this)this.B(new TypeError("A Promise cannot resolve to itself"));else if(d instanceof b)this.N(d);else{a:switch(typeof d){case "object":var e=null!=d;break a;case "function":e=!0;break a;default:e=!1}e?this.K(d):this.H(d)}};
b.prototype.K=function(d){var e=void 0;try{e=d.then}catch(p){this.B(p);return}"function"==typeof e?this.O(e,d):this.H(d)};b.prototype.B=function(d){this.J(2,d)};b.prototype.H=function(d){this.J(1,d)};b.prototype.J=function(d,e){if(0!=this.i)throw Error("Cannot settle("+d+", "+e+"): Promise already settled in state"+this.i);this.i=d;this.l=e;2===this.i&&this.M();this.R()};b.prototype.M=function(){var d=this;n(function(){if(d.S()){var e=z.console;"undefined"!==typeof e&&e.error(d.l)}},1)};b.prototype.S=
function(){if(this.I)return!1;var d=z.CustomEvent,e=z.Event,p=z.dispatchEvent;if("undefined"===typeof p)return!0;"function"===typeof d?d=new d("unhandledrejection",{cancelable:!0}):"function"===typeof e?d=new e("unhandledrejection",{cancelable:!0}):(d=z.document.createEvent("CustomEvent"),d.initCustomEvent("unhandledrejection",!1,!0,d));d.promise=this;d.reason=this.l;return p(d)};b.prototype.R=function(){if(null!=this.g){for(var d=0;d<this.g.length;++d)c.i(this.g[d]);this.g=null}};var c=new g;b.prototype.N=
function(d){var e=this.A();d.C(e.resolve,e.reject)};b.prototype.O=function(d,e){var p=this.A();try{d.call(e,p.resolve,p.reject)}catch(h){p.reject(h)}};b.prototype.then=function(d,e){function p(q,x){return"function"==typeof q?function(F){try{h(q(F))}catch(G){k(G)}}:x}var h,k,m=new b(function(q,x){h=q;k=x});this.C(p(d,h),p(e,k));return m};b.prototype.catch=function(d){return this.then(void 0,d)};b.prototype.C=function(d,e){function p(){switch(h.i){case 1:d(h.l);break;case 2:e(h.l);break;default:throw Error("Unexpected state: "+
h.i);}}var h=this;null==this.g?c.i(p):this.g.push(p);this.I=!0};b.resolve=l;b.reject=function(d){return new b(function(e,p){p(d)})};b.race=function(d){return new b(function(e,p){for(var h=ca(d),k=h.next();!k.done;k=h.next())l(k.value).C(e,p)})};b.all=function(d){var e=ca(d),p=e.next();return p.done?l([]):new b(function(h,k){function m(F){return function(G){q[F]=G;x--;0==x&&h(q)}}var q=[],x=0;do q.push(void 0),x++,l(p.value).C(m(q.length-1),k),p=e.next();while(!p.done)})};return b});
A("Array.prototype.find",function(a){return a?a:function(b,g){a:{var l=this;l instanceof String&&(l=String(l));for(var n=l.length,c=0;c<n;c++){var d=l[c];if(b.call(g,d,c,l)){b=d;break a}}b=void 0}return b}});A("Object.values",function(a){return a?a:function(b){var g=[],l;for(l in b)Object.prototype.hasOwnProperty.call(b,l)&&g.push(b[l]);return g}});
A("Array.prototype.fill",function(a){return a?a:function(b,g,l){var n=this.length||0;0>g&&(g=Math.max(0,n+g));if(null==l||l>n)l=n;l=Number(l);0>l&&(l=Math.max(0,n+l));for(g=Number(g||0);g<l;g++)this[g]=b;return this}});function K(a){return a?a:Array.prototype.fill}A("Int8Array.prototype.fill",K);A("Uint8Array.prototype.fill",K);A("Uint8ClampedArray.prototype.fill",K);A("Int16Array.prototype.fill",K);A("Uint16Array.prototype.fill",K);A("Int32Array.prototype.fill",K);
A("Uint32Array.prototype.fill",K);A("Float32Array.prototype.fill",K);A("Float64Array.prototype.fill",K);var pa={},qa=[];function L(a,b){b&&(this.g=b)}L.file_format=function(){return"DiaryBase"};L.prototype.merge=function(){return this};L.prototype.clone=function(){return sa(this.to("url"),this.g)};
L.prototype.to=function(a){switch(a){case this.file_format():return this;case "url":return"sleep-diary="+encodeURIComponent(JSON.stringify({file_format:this.file_format(),contents:this},function(b,g){return"spreadsheet"==b?void 0:g}));case "json":return JSON.stringify(this,function(b,g){return"spreadsheet"==b?void 0:g});default:if(pa.hasOwnProperty(a))return new pa[a](this.to("Standard"),this.g);throw Error(this.file_format()+" cannot be converted to "+a);}};
L.prototype.to_async=function(a){switch(a){case "spreadsheet":if(!this.spreadsheet.synchronise())throw Error("Could not synchronise data");return this.spreadsheet.serialise();default:var b=this.to(a);return b.then?b:{then:function(g){return g(b)}}}};function P(a,b){return a.g?a.g(b):b}function R(a){var b=a.prototype.format_info();b.constructor=a;qa.push(b);"/"==b.url[0]&&(b.url="https://sleep-diary-formats.github.io"+b.url);"Standard"!=b.name&&(pa[b.name]=b.constructor)}function T(){throw null;}
function ta(a){throw Error("Does not appear to be a valid "+a.file_format()+" file");}function U(a,b){switch(b.file_format()){case "url":return b=b.contents,a.file_format()==b.file_format?(Object.keys(b.contents).forEach(function(g){return a[g]=b.contents[g]}),!0):T();case "string":case "spreadsheet":if(a.spreadsheet.load(b))return!0;case "archive":case "array":T()}return!1}
L.zero_pad=function(a,b){var g="";if(a)for(b=Math.pow(10,(b||2)-1);b>a;b/=10)g+="0";else for(var l=1;l<(b||2);++l)g+="0";return g+a};L.parse_xml=function(a){try{var b=window.DOMParser;if(!b)throw"";}catch(g){b=require("xmldom").DOMParser}return(new b).parseFromString(a,"application/xml")};L.unique=function(a,b,g){var l={};a.forEach(function(n){return l[g(n)]=1});return b.filter(function(n){return!l.hasOwnProperty(g(n))})};
L.escape_xml=function(a){return a.replace(/[&<>"']/g,function(b){return"&#"+b.charCodeAt(0)+";"})};L.date=function(a,b){try{var g=window.tc;if(!g)throw"";}catch(l){g=require("timezonecomplete")}a=new g.DateTime(a||0,g.zone("Etc/UTC"));return b?a.toZone(g.zone(b)):a};
L.status_matches=function(){return[["awake","w.ke",""],["asleep","sle*p(?!.*aid)","#FFFFFF00,#FF0000FF"],["snack","snack","#FFFF7FFF,#FF7FFF7F"],["meal","meal|eat","#FFFF00FF,#FF00FF00"],["alcohol","alco","#FF1FAFEF,#FFE05010"],["chocolate","choc","#FF84C0FF,#FF7B3F00"],["caffeine","caffeine|coffee|tea|cola","#FF0B3B8B,#FFF4C474"],["drink","drink","#FFDF8F5F,#FF2070a0"],["sleep aid","sle*p.*aid|pill|tranq","#FFAFFF7F,#FF500080"],["exercise","exercise","#FF00C0C0,#FFFF3F3F"],["toilet","toilet|bathroom|loo",
"#FF363636,#FFC9C9C9"],["noise","noise","#FF8F8F8F,#FF707070"],["alarm","alarm","#FF000000,#FFFF0000"],["in bed","down|(in|to).*bed","#FFA0A000,#FF5f5fff"],["out of bed","up|out.*bed","#FF0000FF,#FFFFFF00"]]};
function sa(a,b){var g=Error("This does not appear to be a sleep diary"),l=a.file_format;if("string"==typeof a)l="string",a={file_format:function(){return"string"},contents:a};else if(l)"string"==typeof l?a.file_format=function(){return l}:l=l(),"url"==l&&(a.contents=JSON.parse(decodeURIComponent(a.contents.substr(12))));else throw g;"string"==l&&Object.assign(a,V.parse_csv(a.contents));for(var n=0;n!=qa.length;++n)try{return new qa[n].constructor(a,b)}catch(c){c&&(g=c)}throw g;};function ua(a,b){this.success_callback=a||function(){};this.error_callback=b||function(){};var g=this;var l=setInterval(function(){window.tc&&(window.addEventListener("hashchange",function(){return location.hash.replace(/(?:^#|[?&])(sleep-diary=[^&]*)/g,function(n,c){return g.load({file_format:"url",contents:c},"hashchange")})},!1),location.hash.replace(/(?:^#|[?&])(sleep-diary=[^&]*)/g,function(n,c){return g.load({file_format:"url",contents:c},"hash")}),clearInterval(l))},100);va()}
function va(){try{[[window.JSZip,"https://cdn.jsdelivr.net/npm/jszip@3.6.x/dist/jszip.min.js"],[window.tc,"https://cdn.jsdelivr.net/npm/tzdata@1.0.x/tzdata.js","https://cdn.jsdelivr.net/npm/timezonecomplete@5.12.x/dist/timezonecomplete.min.js"],[window.ExcelJS,"https://cdn.jsdelivr.net/npm/exceljs@4.2.x/dist/exceljs.min.js"]].forEach(function(a){a[0]||a.slice(1).forEach(function(b){var g=document.createElement("script");g.src=b;document.head.appendChild(g)})})}catch(a){}}
ua.prototype.load=function(a,b){var g=this,l=window.JSZip;if(!l)return setTimeout(function(){return g.load(a,b)},100);if("string"==typeof a&&!a.search(/^(blob|data):/)){var n=new XMLHttpRequest;n.responseType="blob";n.onload=function(){return g.load([n.response],b)};n.open("GET",a);return n.send()}b||(b=a);a.target&&a.target.files&&(a=a.target.files);if(a.length)Array.from(a).forEach(function(d){var e=new FileReader,p=new l;e.onload=function(){return V.buffer_to_spreadsheet(e.result).then(function(h){return g.load(h,
b)},function(){return p.loadAsync(e.result).then(function(h){function k(){q.length?h.file(q[0]).async("string").then(function(x){m[q[0]]=x;q.shift();k()}):g.load({file_format:"archive",contents:m},b)}var m={},q=Object.keys(h.files);k()},function(){var h=g.error_callback;try{g.error_callback=function(){},g.load({file_format:"array",contents:e.result},b),g.error_callback=h}catch(k){g.error_callback=h,e.onload=function(){return g.load({file_format:"string",contents:e.result},b)},e.readAsText(d)}})})};
e.readAsArrayBuffer(d)});else{try{var c=window.new_sleep_diary(a,ua.serialiser)}catch(d){throw this.error_callback(a,b),d;}c?this.success_callback(c,b):this.error_callback(a,b)}};
ua.serialiser=function(a){switch(a.file_format()){case "array":return a.contents;case "string":return btoa(unescape(encodeURIComponent(a.contents)));case "archive":var b=function(g,l){var n=window.JSZip;if(!n)return setTimeout(function(){return b(g,l)},100);var c=new n;Object.keys(a.contents).forEach(function(d){return c.file(d,a.contents[d])});return c.generateAsync({type:"base64",compression:"DEFLATE"}).then(g,l)};va();return new Promise(b);default:throw Error("Unsupported output format: "+a.file_format());
}};ua.to_url=function(a){if("string"==typeof a)return"data:application/octet-stream;base64,"+a;a.file_format&&a.contents&&("archive"==a.file_format()?a=JSON.stringify(a):a=a.contents);return URL.createObjectURL(new Blob([a]))};var wa={number:"General",time:'YYYY-MM-DD" "HH:MM',duration:"[h]:mm"};
function V(a,b){function g(c){var d=V.create_cell,e=c.member;switch(c.type){case "time":var p=function(k,m,q){return m[q]=d(void 0===k[e]?void 0:new Date(k[e]))};break;case "duration":p=function(k,m,q){return m[q]=d(void 0===k[e]?void 0:k[e]/864E5)};break;default:p=function(k,m,q){return m[q]=d(k[e])}}if(c.optional){var h=p;p=function(k,m,q){return void 0===k[e]||h(k,m,q)}}return p}function l(c,d){var e=c.member;switch(c.type){case "time":var p=function(m,q,x){return!isNaN(m[e]=V.parse_timestamp(q[x].value))};
break;case "duration":p=function(m,q,x){return!isNaN(m[e]=q[x].value.getTime()+d.epoch_offset)};break;case "number":p=function(m,q,x){return!isNaN(m[e]=parseFloat(q[x].value))};break;case "boolean":p=function(m,q,x){return!isNaN(m[e]=!!q[x].value)};break;default:p=function(m,q,x){m[e]=q[x].value;return!0}}if(c.regexp){var h=p;p=function(m,q,x){return c.regexp.test(q[x].value)&&h(m,q,x)}}if(c.optional){var k=p;p=function(m,q,x){return null===(q[x]||{value:null}).value||k(m,q,x)}}return p}var n=this;
this.g=null;this.i=a;this.l=b.map(function(c){return{sheet:c.sheet||c.member,member:c.member||c.sheet,type:c.type||"list",optional:!!c.optional,cells:c.cells.map(function(d){if(d.members){for(d.formats=(d.formats||[]).map(function(e){return wa[e]||e});d.formats.length<d.members.length;)d.formats.push("General");return d}return{members:[d.member],regexp:d.regexp||RegExp(""),formats:[wa[d.type]||"General"],"export":g(d),"import":l(d,n)}})}});this.epoch_offset=0;this.sheets=[]}
V.create_cell=function(a,b){return{value:a,style:b||""}};V.prototype.get_sheet=function(a,b,g){var l=b.join("\x00"),n=this.sheets.filter(function(c){return c.cells[0]&&c.cells[0].map(function(d){return d.value}).join("\x00")==l});return n.length?[!1,n.find(function(c){return c.name==a})||n[0]]:[!0,{name:a,number_formats:g.map(function(c){return c?wa[c]||c:"General"}),cells:[b.map(function(c){return V.create_cell(c,"#FFEEEEEE,#FFEEEEEE")})]}]};
V.parse_timestamp=function(a,b){b=b?(b.properties||{}).date1904?20828448E5:22091616E5:0;if(null===a||void 0===a||"number"==typeof a&&isNaN(a))return NaN;a.hasOwnProperty("value")&&(a=a.value);if(null===a||void 0===a||"number"==typeof a&&isNaN(a))return NaN;if(a.getTime)return a=a.getTime(),864E5>=a&&(a+=b),a;if("number"==typeof a)return a;if(!a||!a.search)return NaN;if(!a.search(/^[0-9]{4,}$/))return a=parseInt(a,10),a*(a<(new Date).getTime()/100?1E3:1);b=(-1==a.search(/[a-su-y]/i)&&-1!=a.search(/-.*-/)?
a:a.replace(/\s*(-|to).*/,"")).replace(/([ap])\s*(m)/i,"$1$2").toLowerCase();if(-1!=b.search(/midnight/i))return 0;if(-1!=b.search(/midd?ay|noon|12pm/i))return 432E5;var g=b.match(/^([0-9]*)(:([0-9]*))?\s*([ap])m$/);if(g)return 36E5*(parseInt(g[1],10)+parseInt(g[3]||"0",10)/60+("p"==g[4]?12:0));if(g=b.match(/^([0-9]*)(:([0-9]*))?$/))return 36E5*(parseInt(g[1],10)+parseInt(g[3]||"0",10)/60);try{return(new Date(b)).getTime()}catch(l){}try{return(new Date(a)).getTime()}catch(l){}return NaN};
V.buffer_to_spreadsheet=function(a){function b(l){return l.hasOwnProperty("argb")?"#"+l.argb:l.hasOwnProperty("indexed")?"i"+l.indexed:l.hasOwnProperty("theme")?"t"+l.theme:""}try{var g=new window.ExcelJS.Workbook}catch(l){g=new (require("exceljs").Workbook)}return g.xlsx.load(a).then(function(){if(g._worksheets.length){var l=[];g.eachSheet(function(n){var c={name:n.name,cells:[]};l.push(c);n.eachRow({includeEmpty:!0},function(d,e){var p=c.cells[e-1]=[];d.eachCell({includeEmpty:!0},function(h,k){var m=
"";h.style&&h.style.fill&&(m=b(h.style.fill.bgColor||{})+","+b(h.style.fill.fgColor||{}));1==m.length&&(m="");if((h.value||{}).getTime){var q=h.value.getTime();if(1==q%1E3||-999==q%1E3)h.value=new Date(q-1);if(-1==q%1E3||999==q%1E3)h.value=new Date(q+1)}p[k-1]=V.create_cell(h.value,m)})})});return{file_format:"spreadsheet",spreadsheet:g,sheets:l}}throw Error("empty spreadsheet");})};
V.parse_csv=function(a){"\ufeff"==a[0]&&(a=a.substr(1));-1==a.search(/\n$/)&&(a+="\n");if(!a.search(/^(([^",\n]*|"([^"]|"")*")(,([^",\n]*|"([^"]|"")*"))*\n)*$/)){try{var b=new window.ExcelJS.Workbook}catch(n){b=new (require("exceljs").Workbook)}var g=b.addWorksheet("Records"),l=[];a.replace(/([^",\n]*|"([^"]|"")*")(,([^",\n]*|"([^"]|"")*"))*\n/g,function(n){var c=g.getRow(1),d=[];l.push(d);n.replace(/([^",\n]*|"([^"]|"")*")[,\n]/g,function(e){var p=c.getCell(1);p.value='"'==e[0]?e.substr(1,e.length-
3).replace(/""/g,'"'):e.substr(0,e.length-1);d.push(V.create_cell(p.value))})});return{spreadsheet:b,sheets:[{name:"Records",cells:l}]}}};V.escape_csv_component=function(a){return void 0===a?"":-1==a.toString().search(/[",\n]/)?a:'"'+a.replace(/"/g,'""')+'"'};
V.prototype.load=function(a){var b=this,g=a.sheets;if(!g)return!1;var l=this.epoch_offset;this.epoch_offset=(a.spreadsheet.properties||{}).date1904?20828448E5:22091616E5;if(!this.l.every(function(n){return g.some(function(c){var d=c.cells,e="dictionary"==n.type;if(!d.length||e&&2!=d.length)return!1;var p=d[0].slice(0);if(!n.cells.every(function(x){return x.members.every(function(F){return F==p.shift().value})}))return!1;var h=[];if(!d.slice(1).every(function(x){var F=0,G={};h.push(G);return n.cells.every(function(H){return H["import"](G,
x,(F+=H.members.length)-H.members.length)})}))return!1;var k=n.member;if(e)b.i[k]=Object.assign(h[0],b.i[k]||{});else{b.i[k]||(b.i[k]=[]);var m=b.i[k];m.length>=d.length&&m.splice(0,d.length-1);h.forEach(function(x,F){return m[F]=Object.assign(x,m[F])})}var q=[];n.cells.forEach(function(x){return q=q.concat(x.formats)});c.number_formats=q;return!0})}))return this.epoch_offset=l,!1;this.g=a.spreadsheet;this.sheets=g;return!0};
V.prototype.synchronise=function(){var a=this;return this.l.every(function(b){function g(k){var m=[],q=0;p.push(m);return b.cells.every(function(x){return x["export"](k,m,(q+=x.members.length)-x.members.length)})}var l="dictionary"==b.type,n=[],c=[];b.cells.forEach(function(k){n=n.concat(k.members);c=c.concat(k.formats)});var d=a.get_sheet(b.sheet,n,c),e=d[0];d=d[1];var p=d.cells=[n.map(function(k){return V.create_cell(k,"#FFEEEEEE,#FFEEEEEE")})],h=a.i[b.member||b.sheet];if(l){if(!g(h))return!1}else if(!h.every(g))return!1;
e&&a.sheets.push(d);return!0})};
V.prototype.serialise=function(){function a(c){switch(c[0]){case "#":return{argb:c.slice(1)};case "i":return{indexed:parseInt(c.slice(1),10)};case "t":return{theme:parseInt(c.slice(1),10)};default:return{}}}var b=this,g=!this.g;if(!this.g){try{this.g=new window.ExcelJS.Workbook}catch(c){this.g=new (require("exceljs").Workbook)}this.epoch_offset=(this.g.properties||{}).date1904?20828448E5:22091616E5}var l=this.epoch_offset,n={};this.sheets.forEach(function(c){return n[c.name]=0});this.g.eachSheet(function(c,
d){n.hasOwnProperty(c.name)?n[c.name]=c:b.g.da(d)});this.sheets.forEach(function(c){var d=n[c.name]||b.g.addWorksheet(c.name);d.eachRow({includeEmpty:!0},function(e,p){var h=c.cells[p-1]||[];e.eachCell({includeEmpty:!0},function(k,m){h[m]||(k.value=null,k.style={})})});c.cells.forEach(function(e,p){var h=d.getRow(p+1);e.forEach(function(k,m){m=h.getCell(m+1);m.value=g&&(k.value||{}).getTime&&0<=k.value.getTime()&&864E5>k.value.getTime()?new Date(k.value.getTime()-l):k.value;k=k.style.split(",");k[0]||
k[1]?(m=m.style={},m.fill=m.fill||{},m.fill.type="pattern",m.fill.pattern="solid",k[0]?m.fill.bgColor=a(k[0]):delete m.fill.bgColor,k[1]?m.fill.fgColor=a(k[1]):delete m.fill.fgColor):m&&m.fill&&(delete m.fill.bgColor,delete m.fill.fgColor)});h.commit()});(c.widths||[]).forEach(function(e,p){return d.columns[p].width=e});c.number_formats.forEach(function(e,p){return d.getColumn(p+1).numFmt=e})});return this.g.xlsx.writeBuffer()};V.prototype.file_format=function(){return"Spreadsheet"};"undefined"!==typeof module&&module.exports?module.exports={new_sleep_diary:sa,sleep_diary_formats:qa,DiaryLoader:ua,Spreadsheet:V}:(window.new_sleep_diary=sa,window.sleep_diary_formats=qa,window.DiaryLoader=ua,window.Spreadsheet=V);var ya={X:"awake",ba:"in bed",W:"asleep",ea:"snack",ca:"meal",V:"alcohol",Z:"chocolate",Y:"caffeine",$:"drink","sleep aid":"sleep aid",aa:"exercise",ga:"toilet",P:"noise",U:"alarm","in bed":"in bed","out of bed":"out of bed"};
function W(a,b){b&&(this.g=b);a.records&&!a.file_format&&(a={file_format:function(){return"Standard"},contents:a});this.spreadsheet=new V(this,[{sheet:"Records",member:"records",cells:[{member:"status",regexp:new RegExp("^("+Object.values(ya).join("|")+")$"),type:"string"},{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},{member:"start_timezone",type:"string",optional:!0},{member:"end_timezone",type:"string",optional:!0},{member:"duration",type:"duration",optional:!0},
{members:["tags"],"export":function(h,k,m){return k[m]=V.create_cell((h.tags||[]).join("; "))},"import":function(h,k,m){k[m].value&&(h.tags=k[m].value.split(/ *; */));return!0}},{members:["comments"],"export":function(h,k,m){return k[m]=V.create_cell((h.comments||[]).map(function(q){return q.time?"TIME="+q.time+" "+q.text:q}).join("; "))},"import":function(h,k,m){k[m].value&&(k=k[m].value.split(/ *; */).map(function(q){var x;q=q.replace(/^TIME=([0-9]*) */,function(F,G){x=parseInt(G,10);return""});
return x?{time:x,text:q}:q}),h.comments=k);return!0}},{member:"day_number",type:"number",optional:!0},{member:"start_of_new_day",type:"boolean",optional:!0},{member:"is_primary_sleep",type:"boolean",optional:!0},{member:"missing_record_after",type:"boolean",optional:!0}]},{sheet:"Settings",member:"settings",type:"dictionary",cells:[{member:"minimum_day_duration",type:"duration"},{member:"maximum_day_duration",type:"duration"}]}]);switch(a.file_format()){case "string":try{a={file_format:function(){return"Standard"},
contents:JSON.parse(a.contents)}}catch(h){return T()}if("Standard"!=a.contents.file_format)return T();default:if(!U(this,a)){b=a.contents;if("Standard"!=a.file_format()||null===b||"object"!=typeof b||!Array.isArray(b.records))return T();this.records=b.records.map(function(h){return Object.assign({},h)}).sort(function(h,k){return h.start-k.start||h.end-k.end});a=b.settings||b;var g=a.minimum_day_duration||72E6,l=a.maximum_day_duration||2*g;this.settings={minimum_day_duration:g,maximum_day_duration:l};
var n=0,c=0,d={status:"",day_number:-1},e=[],p=d;this.records.forEach(function(h){["start","end"].forEach(function(m){void 0==h[m]&&delete h[m]});["tags","comments"].forEach(function(m){(h[m]||[]).length||delete h[m]});h.hasOwnProperty("duration")||(h.duration=h.end-h.start,isNaN(h.duration)&&delete h.duration);h.hasOwnProperty("start_of_new_day")?h.start_of_new_day&&(n=h.start):h.start_of_new_day="asleep"==h.status&&h.start>n+g;h.hasOwnProperty("day_number")?c=h.day_number:(h.start_of_new_day&&(c=
h.start>n+l?c+2:c+1,n=h.start),h.day_number=c);if("awake"==h.status||"asleep"==h.status)p.hasOwnProperty("missing_record_after")||(p.missing_record_after=h.status==p.status),p=h;"asleep"==h.status&&(e[h.day_number]||{duration:-Infinity}).duration<h.duration&&(e[h.day_number]=h);if(h.hasOwnProperty("comments")){var k=h.comments;void 0===k?delete h.comments:Array.isArray(k)||(h.comments=[k])}d=h});e.forEach(function(h){h&&!h.hasOwnProperty("is_primary_sleep")&&(h.is_primary_sleep=!0)})}}}J(W,L);
W.prototype.to=function(a){switch(a){case "output":return a=Object.assign({file_format:this.file_format()},this),delete a.spreadsheet,P(this,{file_format:function(){return"string"},contents:JSON.stringify(a)});default:return L.prototype.to.call(this,a)}};
W.prototype.merge=function(a){var b={};[this,a.to(this.file_format())].forEach(function(g){return g.records.forEach(function(l){return b[[l.start,l.end,l.status].join()]=l})});this.records=Object.values(b).sort(function(g,l){return g.start-l.start||g.end-l.end});return this};W.prototype.file_format=function(){return"Standard"};W.prototype.format_info=function(){return{name:"Standard",title:"Standardised diary format",url:"/src/Standard",extension:".json"}};
function za(a){function b(k,m){return k+Math.pow(m-h,2)}function g(k,m){return k+m}var l=a.filter(function(k){return void 0!==k}),n=l.length;if(!n)return null;var c=l.sort(function(k,m){return k-m}),d=c.slice(Math.round(.25*c.length),Math.round(.75*c.length)),e=l.reduce(g)/(n||1),p=d.reduce(g)/(d.length||1);a={average:e,mean:e,interquartile_mean:p,median:c[Math.floor(c.length/2)],interquartile_range:d[d.length-1]-d[0],durations:a,interquartile_durations:d};var h=e;a.standard_deviation=Math.sqrt(l.reduce(b,
0)/n);h=p;a.interquartile_standard_deviation=Math.sqrt(d.reduce(b,0)/d.length);return a}W.prototype.summarise_records=function(a){return za((a?this.records.filter(a):this.records).map(function(b){return b.duration}))};W.prototype.summarise_days=function(a){var b=[];for((a?this.records.filter(a):this.records).forEach(function(l){if(b[l.day_number]||0<l.start)b[l.day_number]=l.start});b.length&&!b[0];)b.shift();a=[];for(var g=1;g<b.length;++g)b[g]&&b[g-1]&&(a[g-1]=b[g]-b[g-1]);return za(a)};
W.prototype.summarise_schedule=function(a,b){b=b||864E5;var g=b/2,l=[],n=[],c=[],d=[];(a?this.records.filter(a):this.records).forEach(function(k){k.is_primary_sleep&&(k.start&&(l.push(k.start%b),n.push((k.start+g)%b)),k.end&&(c.push(k.end%b),d.push((k.end+g)%b)))});a=za(l);var e=za(n),p=za(c),h=za(d);[[e,a],[h,p]].forEach(function(k){k[0]&&(["average","mean","interquartile_mean","median"].forEach(function(m){return k[0][m]=(k[0][m]+g)%b}),["durations","interquartile_durations"].forEach(function(m){return k[0][m]=
k[1][m]}))});return{wake:(p||{}).standard_deviation<(h||{}).standard_deviation?p:h,sleep:(a||{}).standard_deviation<(e||{}).standard_deviation?a:e}};W.prototype.latest_sleep_status=function(){for(var a=this.records.length-1;0<=a;--a){var b=this.records[a].status;if("awake"==b||"asleep"==b)return b}return""};R(W);function Aa(a,b){function g(f){return f.substr(1,f.length-2)}function l(f){return(new Date(f.substr(1,f.length-2))).getTime()}function n(f){var r=f.match(y);return{string:f,year:parseInt(r[1],10),month:parseInt(r[2],10),day:parseInt(r[3],10),hour:parseInt(r[4],10),minute:parseInt(r[5],10),offset:("-"==r[6]?-1:1)*(60*parseInt(r[7],10)+parseInt(r[8],10))}}function c(f,r){f=L.date(f,r);r=f.offset();return{string:'"'+f.year()+"-"+L.zero_pad(f.month())+"-"+L.zero_pad(f.day())+" "+L.zero_pad(f.hour())+
":"+L.zero_pad(f.minute())+(0>r?"-":"+")+L.zero_pad(Math.abs(Math.round(r/60)))+L.zero_pad(Math.abs(r%60))+'"',year:f.year(),month:f.month(),day:f.day(),hour:f.hour(),minute:f.minute(),offset:r}}function d(f,r){var w=Math.floor(r/60),u=Math.floor(r%60);f=new Date((f.getTime?f.getTime():f)+6E4*(60*w+u));return{string:'"'+f.getUTCFullYear()+"-"+L.zero_pad(f.getUTCMonth()+1)+"-"+L.zero_pad(f.getUTCDate())+" "+L.zero_pad(f.getUTCHours())+":"+L.zero_pad(f.getUTCMinutes())+("-"==r[0]?"":"+")+L.zero_pad(Math.floor(r/
60),2)+L.zero_pad(Math.floor(r%60),2)+'"',year:f.getUTCFullYear(),month:f.getUTCMonth()+1,day:f.getUTCDate(),hour:f.getUTCHours(),minute:f.getUTCMinutes(),offset:r}}function e(f){var r=[];if(""!=f){f=f.split("|");for(var w=0;w!=f.length;++w){var u=f[w].split("-");r.push({wake:parseInt(u[0],10),sleep:parseInt(u[1],10)})}}return r}function p(f){var r=[];if(f.length&&"NONE"!=f){f=f.split("|");for(var w=0;w!=f.length;++w){var u=f[w].split(":");r.push({type:u[0],mood:parseInt(u[1],10),themes:u.slice(2)})}}return r}
function h(f){return f.length&&"NONE"!=f?f.split("|"):[]}function k(f){f=f.match(N);return{custom_aid_id:f[1],"class":f[2],name:g(f[3])}}function m(f){f=f.match(X);return{custom_hindrance_id:f[1],"class":f[2],name:g(f[3])}}function q(f){f=f.match(S);return{custom_tag_id:f[1],name:g(f[2])}}function x(f){f=f.match(v);var r=e(f[28]);return{start:l(f[19]),end:l(f[1]),duration:r.reduce(function(w,u){return w+u.sleep-u.wake},l(f[1])-l(f[10])),wake:n(f[1]),sleep:n(f[10]),bedtime:n(f[19]),holes:r,type:f[34],
dreams:p(f[35]),aids:h(f[47]),hindrances:h(f[51]),tags:h(f[55]),quality:parseInt(f[59],10),notes:g(f[60])}}function F(f){var r=!0,w={D:[],F:[],G:[],u:[]};f=f.split("\n");for(var u=0;u!=f.length;++u){var I=f[u];if(r){switch(I){case "custom_aid_id,class,name":var B=w.D;var E=N;break;case "custom_hindrance_id,class,name":B=w.F;E=X;break;case "custom_tag_id,name":B=w.G;E=S;break;case "wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes":B=w.u;E=v;break;default:if(B)B[B.length-1]+="\n",
--u;else return ta(this)}r=!1}else if(""==f[u])r=!0;else{for(;'"'!=I.substr(I.length-1);){if(++u==f.length)return ta(this);I+="\n"+f[u]}if(E.test(I))B.push(I);else if(B.length)B[B.length-1]+="\n"+I;else return ta(this)}}return w}b&&(this.g=b);var G="ALCOHOL AMBIEN AMBIEN_CR AROMATHERAPY BENADRYL CHAMOMILE CIRCADIN CPAP DOZILE EAR_PLUGS EXERCISE GABA IMOVANE LUNESTA MAGNESIUM MARIJUANA MEDITATION MELATONIN MILK MUSIC NYQUIL READING RESTAVIT ROZEREM SEX SOUND_MACHINE ST_JOHNS_WORT TV TYLENOL TYLENOL_PM UNISOM UNISOM2 VALERIAN ZIMOVANE".split(" "),
H="ALARM_CLOCK ANGER ANXIETY ARGUMENT BABY_CRYING BATHROOM_BREAK TOO_BRIGHT BUNKMATE_SNORING CAFFEINE TOO_COLD DOG_BARKING FIRE_ANTS HEARTBURN TOO_HOT HUNGER LOUD_NEIGHBOR MIND_RACING PAIN PHONE_RANG RESTLESS_LEGS SCARY_MOVIE SICK SQUIRRELS_ON_ROOF STORM STRESS SUGAR VIDEO_GAME WIND".split(" "),M="ALONE BUNKMATE CAMPING COUCH GOING_FISHING HOTEL OUT_OF_TOWN PASSED_OUT_DRUNK SCHOOL_NIGHT SLEEP_TALKING SLEEP_WALKING SLEPT_AT_FRIENDS_PLACE SLEPT_IN_CAR WORK_NIGHT".split(" ");b=G.join("|")+"|CUSTOM_[0-9]*";
var O=H.join("|")+"|CUSTOM_[0-9]*",Y=M.join("|")+"|CUSTOM_[0-9]*",Q={};[G,H,M].forEach(function(f,r){return f.forEach(function(w){return Q[w]=r})});G=/^CUSTOM_[0-9]*$/;var N=/^(CUSTOM_[0-9]*),(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND),("(.|\n)*")$/,X=/^(CUSTOM_[0-9]*),(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT),("(.|\n)*")$/,S=/^(CUSTOM_[0-9]*),("(.|\n)*")$/,v=new RegExp('^("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),(|([1-9][0-9]*)-([1-9][0-9]*)(\\|([1-9][0-9]*)-([1-9][0-9]*))*),(NIGHT_SLEEP|NAP),(NONE|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*)(\\|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*))*),(NONE|('+
(b+")(\\|("+b+"))*),(NONE|(")+(O+")(\\|("+O+"))*),(NONE|(")+(Y+")(\\|("+Y+'))*),([0-9]|10),("(.|\n)*")$')),y=/"([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"/;this.spreadsheet=new V(this,[{sheet:"Records",member:"records",cells:[{members:["start","start_offset"],formats:["time",null],"export":function(f,r,w){r[w]=V.create_cell(new Date(f.start));r[w+1]=V.create_cell(f.bedtime.offset);return!0},"import":function(f,r,w){f.start=r[w].value.getTime();
return f.bedtime=d(r[w].value,r[w+1].value)}},{members:["end","end_offset"],formats:["time",null],"export":function(f,r,w){r[w]=V.create_cell(new Date(f.end));r[w+1]=V.create_cell(f.wake.offset);return!0},"import":function(f,r,w){f.end=r[w].value.getTime();return f.wake=d(r[w].value,r[w+1].value)}},{member:"duration",type:"duration"},{members:["sleep","sleep_offset"],formats:["time",null],"export":function(f,r,w){r[w]=V.create_cell(new Date(f.sleep.string.substr(1,f.sleep.string.length-2)));r[w+1]=
V.create_cell(f.sleep.offset);return!0},"import":function(f,r,w){return f.sleep=d(r[w].value,r[w+1].value)}},{members:["holes"],regexp:/^([0-9]*-[0-9]*)*$/,"export":function(f,r,w){r[w]=V.create_cell(f.holes.map(function(u){return u.wake+"-"+u.sleep}).join("|"));return!0},"import":function(f,r,w){f.holes=e(r[w].value);return!0}},{member:"type",regexp:/^(NIGHT_SLEEP|NAP)$/},{members:["dreams"],"export":function(f,r,w){r[w]=V.create_cell(f.dreams.map(function(u){return[u.type,u.mood].concat(u.themes).join(":")}).join("|"));
return!0},"import":function(f,r,w){return f.dreams=p(r[w].value)}},{members:["aids"],"export":function(f,r,w){r[w]=V.create_cell(f.aids.join("|"));return!0},"import":function(f,r,w){f.aids=h(r[w].value);return!0}},{members:["hindrances"],"export":function(f,r,w){r[w]=V.create_cell(f.hindrances.join("|"));return!0},"import":function(f,r,w){f.hindrances=h(r[w].value);return!0}},{members:["tags"],"export":function(f,r,w){r[w]=V.create_cell(f.tags.join("|"));return!0},"import":function(f,r,w){f.tags=
h(r[w].value);return!0}},{member:"quality",regexp:/^[0-9]*$/},{member:"notes"}]},{sheet:"Custom Aids",member:"custom_aids",cells:[{member:"custom_aid_id",regexp:G},{member:"class",regexp:/^(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND)$/},{member:"name"}]},{sheet:"Custom Hindrances",member:"custom_hindrances",cells:[{member:"custom_hindrance_id",regexp:G},{member:"class",regexp:/^(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT)$/},{member:"name"}]},{sheet:"Custom Tags",
member:"custom_tags",cells:[{member:"custom_tag_id",regexp:G},{member:"name"}]}]);b=[];O=[];var C=[],t=[];switch(a.file_format()){case "string":if(-1==a.contents.search("wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes"))return T();a=F(a.contents);b=a.D.map(k);O=a.F.map(m);C=a.G.map(q);t=a.u.map(x);break;default:if(U(this,a))return;var D={};a.to("Standard").records.forEach(function(f){switch(f.status){case "in bed":D[f.end]=[f.start,f.start_timezone];break;case "asleep":var r=
[[],[],[]],w=D[f.start]||[f.start,f.start_timezone];(f.tags||[]).forEach(function(u){if(Q.hasOwnProperty(u))r[Q[u]].push(u);else{var I=C.find(function(B){return u==B.name});I?r[2].push(I.custom_tag_id):(I="CUSTOM_"+L.zero_pad(C.length+1,4),C.push({custom_tag_id:I,name:u}),r[2].push(I))}});t.push({start:w[0],end:f.end,duration:f.duration,wake:c(f.end,f.end_timezone),sleep:c(f.start,f.start_timezone),bedtime:c(w[0],w[1]),holes:[],type:f.is_primary_sleep?"NIGHT_SLEEP":"NAP",dreams:[],aids:r[0],hindrances:r[1],
tags:r[2],quality:5,notes:(f.comments||[]).join("; ")})}})}this.custom_aids=b;this.custom_hindrances=O;this.custom_tags=C;this.records=t}J(Aa,L);
Aa.prototype.to=function(a){switch(a){case "output":var b="";this.custom_aids.length&&(b+="custom_aid_id,class,name\n",this.custom_aids.forEach(function(e){return b+=e.custom_aid_id+","+e["class"]+',"'+e.name+'"\n'}),b+="\n");this.custom_hindrances.length&&(b+="custom_hindrance_id,class,name\n",this.custom_hindrances.forEach(function(e){return b+=e.custom_hindrance_id+","+e["class"]+',"'+e.name+'"\n'}),b+="\n");this.custom_tags.length&&(b+="custom_tag_id,name\n",this.custom_tags.forEach(function(e){return b+=
e.custom_tag_id+',"'+e.name+'"\n'}),b+="\n");b+="wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes\n";this.records.forEach(function(e){return b+=[e.wake.string,e.sleep.string,e.bedtime.string,e.holes.map(function(p){return p.wake+"-"+p.sleep}).join("|"),e.type,e.dreams.map(function(p){return[p.type,p.mood].concat(p.themes).join(":")}).join("|")||"NONE",e.aids.join("|")||"NONE",e.hindrances.join("|")||"NONE",e.tags.join("|")||"NONE",e.quality,'"'+e.notes+'"'].join()+"\n"});return P(this,
{file_format:function(){return"string"},contents:b});case "Standard":var g=function(e){e=Math.round(e.offset/60);return 0>e?"Etc/GMT+"+Math.abs(e):0<e?"Etc/GMT-"+e:"Etc/GMT"},l={},n={},c={},d=[];this.custom_aids.forEach(function(e){return l[e.custom_aid_id]=e.name});this.custom_hindrances.forEach(function(e){return n[e.custom_hindrance_id]=e.name});this.custom_tags.forEach(function(e){return c[e.custom_tag_id]=e.name});this.records.forEach(function(e){var p=e.sleep;p=(new Date(p.string.substr(1,p.string.length-
2))).getTime();e.start<p&&d.push({status:"in bed",start:e.start,end:p,start_timezone:g(e.bedtime),end_timezone:g(e.sleep)});var h=[];e.aids.forEach(function(k){return h.push(l[k]||k)});e.hindrances.forEach(function(k){return h.push(n[k]||k)});e.tags.forEach(function(k){return h.push(c[k]||k)});d.push(Object.assign({status:"asleep",start:void 0===e.start?p||void 0:Math.max(e.start,p),end:e.end,start_timezone:g(e.sleep),end_timezone:g(e.wake),tags:h,comments:e.notes.length?[e.notes]:[]},void 0===e.duration?
{}:{duration:e.duration},"NIGHT_SLEEP"==e.type?{is_primary_sleep:!0}:{}))});return new W({records:d},this.g);default:return L.prototype.to.call(this,a)}};
Aa.prototype.merge=function(a){var b=this,g={},l={},n={};a=a.to(this.file_format());this.custom_aids.length&&a.custom_aids.length?a.custom_aids.forEach(function(c){var d=b.custom_aids.find(function(p){return p["class"]==c["class"]&&p.name==c.name});if(!d){var e="CUSTOM_0001";for(d=2;b.custom_aids.some(function(p){return p.custom_aid_id==e});++d)e="CUSTOM_"+L.zero_pad(d,4);d={custom_aid_id:e,"class":c["class"],name:c.name};b.custom_aids.push(d)}g[c.custom_aid_id]=d.custom_aid_id}):a.custom_aids.forEach(function(c){return g[c.custom_aid_id]=
c.custom_aid_id});this.custom_hindrances.length&&a.custom_hindrances.length?a.custom_hindrances.forEach(function(c){var d=b.custom_hindrances.find(function(p){return p["class"]==c["class"]&&p.name==c.name});if(!d){var e="CUSTOM_0001";for(d=2;b.custom_hindrances.some(function(p){return p.custom_hindrance_id==e});++d)e="CUSTOM_"+L.zero_pad(d,4);d={custom_hindrance_id:e,"class":c["class"],name:c.name};b.custom_hindrances.push(d)}l[c.custom_hindrance_id]=d.custom_hindrance_id}):a.custom_hindrances.forEach(function(c){return l[c.custom_hindrance_id]=
c.custom_hindrance_id});this.custom_tags.length&&a.custom_tags.length?a.custom_tags.forEach(function(c){var d=b.custom_tags.find(function(p){return p.name==c.name});if(!d){var e="CUSTOM_0001";for(d=2;b.custom_tags.some(function(p){return p.custom_tag_id==e});++d)e="CUSTOM_"+L.zero_pad(d,4);d={custom_tag_id:e,name:c.name};b.custom_tags.push(d)}n[c.custom_tag_id]=d.custom_tag_id}):a.custom_tags.forEach(function(c){return n[c.custom_tag_id]=c.custom_tag_id});this.records=this.records.concat(L.unique(this.records,
a.records,function(c){return[c.wake.string,c.sleep.string,c.bedtime.string].join()}).map(function(c){return Object.assign({},c,{aids:c.aids.map(function(d){return g[d]||d}),hindrances:c.hindrances.map(function(d){return l[d]||d}),tags:c.tags.map(function(d){return n[d]||d})})})).sort(function(c,d){return c.wake-d.wake});return this};Aa.prototype.file_format=function(){return"Sleepmeter"};
Aa.prototype.format_info=function(){return{name:"Sleepmeter",title:"Sleepmeter",url:"/src/Sleepmeter",statuses:["in bed","asleep"],extension:".csv"}};R(Aa);function Z(a,b){function g(t){return t.substr(1,t.length-2).replace(N,'"').replace(X,"\n")}function l(t){var D=[];t.replace(Y,function(f,r){3<r.length&&("_2x"==r.substr(r.length-3)?D.push({count:2,value:r.substr(0,r.length-3)}):"_3x"==r.substr(r.length-3)?D.push({count:3,value:r.substr(0,r.length-3)}):D.push({count:1,value:r}))});return D}function n(t){var D=t.match(G);return{string:t,year:parseInt(D[3],10),month:parseInt(D[2],10),day:parseInt(D[1],10),hour:parseInt(D[4],10),minute:parseInt(D[5],
10)}}function c(t,D){t=L.date(t,D);return{string:'"'+L.zero_pad(t.day())+". "+L.zero_pad(t.month())+". "+t.year()+" "+t.hour()+":"+L.zero_pad(t.minute())+'"',year:t.year(),month:t.month(),day:t.day(),hour:t.hour(),minute:t.minute()}}function d(t,D){return D.some(function(f){return f==t})?null:p(t)}function e(t,D){return D.some(function(f){return f==t})?null:p(t)}function p(t){return parseFloat(t.substr(1,t.length-2))}function h(t,D){return D.some(function(f){return f==t})?null:g(t)}function k(t){var D=
{},f=L.parse_xml(t).documentElement;t=Array.from(f.getElementsByTagName("long"));var r=Array.from(f.getElementsByTagName("int")),w=Array.from(f.getElementsByTagName("boolean"));f=Array.from(f.getElementsByTagName("string"));t.forEach(function(u){return D[u.getAttribute("name")]=parseInt(u.getAttribute("value"),10)});r.forEach(function(u){return D[u.getAttribute("name")]=parseInt(u.getAttribute("value"),10)});w.forEach(function(u){return D[u.getAttribute("name")]="true"==u.getAttribute("value")});
f.forEach(function(u){return D[u.getAttribute("name")]=u.textContent});return D}function m(t){var D=[];t=t.split("\n");""==t[t.length-1]&&t.pop();for(var f={},r=0;r!=t.length;f={h:f.h,s:f.s,m:f.m,v:f.v,o:f.o},r+=2){var w=function(B){return function(E){return L.date(["year","month","day"].map(function(aa){return L.zero_pad(E[aa])}).join("-")+"T"+["hour","minute"].map(function(aa){return L.zero_pad(E[aa])}).join(":"),B.h.Tz).unixUtcMillis()}}(f),u=t[r].match(q);f.s=[];f.m=[];if(!u)return ta(this);u[1].replace(H,
function(B){return function(E,aa,ra){B.s.push({header_string:E,hours:parseInt(aa,10),minutes:parseInt(ra,10),actigraphy:null,noise:null})}}(f));u[5].replace(/"Event"/g,function(B){return function(){B.m.push({label:null,timestamp:null})}}(f));u=t[r+1].match(x);if(!u)return ta(this);f.v=0;f.o=0;var I=g(u[27]);f.h={Id:g(u[1]),Tz:g(u[3]),From:n(u[5]),To:n(u[11]),Sched:n(u[17]),Hours:p(u[23]),Rating:p(u[25]),Comment:{string:I,tags:l(I),notags:I.replace(Q,"")},Framerate:g(u[29]),Snore:d(u[31],['"-1"']),
Noise:e(u[32],['"-1.0"']),Cycles:d(u[34],['"-1"']),DeepSleep:e(u[35],['"-1.0"','"-2.0"']),LenAdjust:e(u[37],['"-1.0"']),Geo:h(u[39],[""]),times:f.s,events:f.m};f.h.start=parseInt(f.h.Id,10);f.h.end=f.h.start+36E5*f.h.Hours;f.h.duration=Math.round(6E4*(60*f.h.Hours+("-1.0"==u[37]?0:f.h.LenAdjust)));f.h.alarm=6E4*Math.round((f.h.end+w(f.h.Sched)-w(f.h.To))/6E4);u[40].replace(M,function(B){return function(E){B.s[B.v++].T=p(E)}}(f));u[43].replace(O,function(B){return function(E,aa,ra,Fa,xa){B.m[B.o].label=
aa;B.m[B.o].timestamp=parseInt(ra,10);xa&&(B.m[B.o].value=parseFloat(xa));++B.o}}(f));if(w=t[r+2]?t[r+2].match(F):0)f.v=0,w[1].replace(M,function(B){return function(E){B.s[B.v++].P=p(E)}}(f)),++r;D.push(f.h)}return D}b&&(this.g=b);var q=/^Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)$/,x=/^("([^"]|"")*"),("([^"]|"")*"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(.[0-9]*)?"),("[0-9]*(.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(.[0-9]*)?"),("-?[0-9]*"),("(-[12].0|0.[0-9]*|1.0)"),("-?[0-9]*(.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)$/,
F=/^,,,,,,,,,,,,((,"-?[0-9]*(.[0-9]*)?")*)$/;b=/^(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(.[0-9]*)?"),("[0-9]*(.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(.[0-9]*)?"),("-?[0-9]*"),("(-[12].0|0.[0-9]*|1.0)"),("-?[0-9]*(.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)\n(,,,,,,,,,,,,((,"-?[0-9]*(.[0-9]*)?")*)\n)?)*(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(.[0-9]*)?"),("[0-9]*(.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(.[0-9]*)?"),("-?[0-9]*"),("(-[12].0|0.[0-9]*|1.0)"),("-?[0-9]*(.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)(\n,,,,,,,,,,,,((,"-?[0-9]*(.[0-9]*)?")*))?)\n?$/;
var G=/"([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"/,H=/"([0-9]*):([0-9]*)"/g,M=/"-?[0-9]*(.[0-9]*)?"/g,O=/"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?"/g,Y=/#([^ ",][^ ",]*)/g,Q=/ *#([^ ",][^ ",]*)/g,N=/""/g,X=/ \\n /g,S={},v=[];this.spreadsheet=new V(this,[]);var y=a.contents;switch(a.file_format()){case "spreadsheet":if(!a.sheets.some(function(t){t=t.cells;if(!t.length)return!1;C=[];var D=1,f,r,w;return t.every(function(u){if("Id,Tz,From,To,Sched,Hours,Rating,Comment,Tags,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo"==
u.slice(0,16).map(function(B){return B.value}).join())r=[],w=[],f={times:r,events:w},C.push(f),D=2,u.slice(16).forEach(function(B){if("Event"==B.value)w.push({label:null,timestamp:null});else if("number"==typeof B.value){var E=Math.floor(24*B.value);B=Math.floor(1440*B.value)%60;r.push({header_string:E+":"+L.zero_pad(B),hours:E,minutes:B,actigraphy:null,noise:null})}else return!1});else if(2==D){D=3;["Id","Tz",,,,"Hours","Rating","Comment","Tags","Framerate","Snore","Noise","Cycles","DeepSleep","LenAdjust",
"Geo"].forEach(function(B,E){return f[B]=u[E]?u[E].value:null});f.Comment=f.Comment&&f.Tags?{string:f.Comment+" "+f.Tags,tags:l(f.Tags),notags:f.Comment}:f.Comment?{string:f.Comment,tags:[],notags:f.Comment}:f.Tags?{string:f.Tags,tags:l(f.Tags),notags:""}:{string:"",tags:[],notags:""};delete f.Tags;var I=u[1].value;f.start=u[2].value.getTime();f.From=c(u[2].value.getTime(),I);f.end=u[3].value.getTime();f.To=c(u[3].value.getTime(),I);f.alarm=u[4].value.getTime();f.Sched=c(u[4].value.getTime(),I);f.duration=
Math.round(6E4*(60*f.Hours+(f.LenAdjust||0)));r.forEach(function(B,E){u[16+E]&&(B.actigraphy=u[16+E].value)});w.forEach(function(B,E){u[16+r.length+E]&&(E=u[16+r.length+E].value.split("-"),B.label=E[0],B.timestamp=E[1],2<E.length&&(B.value=E[2]))})}else if(3==D)D=1,r.forEach(function(B,E){u[16+E]&&(B.noise=u[16+E].value)});else return!1;return!0})})||!a.sheets.some(function(t){t=t.cells;if(!t.length||"Alarm"!=t[0][0].value)return!1;v=t.slice(1).map(function(D){return JSON.parse(D[0].value)});return!0})||
!a.sheets.some(function(t){t=t.cells;if(!t.length||"Preferences"!=t[0][0].value)return!1;S=JSON.parse(t[1][0].value);return!0}))return T();break;case "string":if(!b.test(y))return T();var C=m.call(this,y);break;case "archive":if(y.hasOwnProperty("sleep-export.csv")&&y["prefs.xml"]&&y["alarms.json"]){C=m.call(this,y["sleep-export.csv"]);S=k(y["prefs.xml"]);v=JSON.parse(y["alarms.json"]);break}else return T();default:if(U(this,a))return;C=a.to("Standard").records.filter(function(t){return"asleep"==
t.status}).map(function(t){return{start:t.start,end:t.end,duration:t.duration,alarm:6E4*Math.round(t.end/6E4),Id:(t.start||0).toString(),Tz:t.start_timezone||t.end_timezone||"Etc/GMT",From:c(t.start,t.start_timezone||t.end_timezone),To:c(t.end,t.end_timezone||t.start_timezone),Sched:c(t.end,t.end_timezone||t.start_timezone),Hours:(t.end-t.start)/36E5,Rating:2.5,Comment:{string:(t.comments||[]).join("\n")+(t.tags||[]).map(function(D){return"#"+D}).join(" "),tags:(t.tags||[]).map(function(D){return{count:1,
value:D}}),notags:(t.comments||[]).join("\n")},Framerate:"10000",Snore:null,Noise:null,Cycles:null,DeepSleep:null,LenAdjust:null,Geo:"",times:[],events:[]}})}this.records=C;this.prefs=S;this.alarms=v}J(Z,L);
Z.prototype.to=function(a){var b=this,g=["Id","Tz","From","To","Sched"],l=["Hours","Rating"],n="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "output":var c=function(p,h){return'"'+(null===p?h:p)+'"'};a=JSON.stringify(this.alarms);var d="<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n<map>"+Object.keys(this.prefs).map(function(p){var h=b.prefs[p];switch(typeof h){case "boolean":return'\n\t<boolean name="'+p+'" value="'+h+'" />\n';case "number":return"\n\t<"+
(Math.abs(h)>=Math.pow(2,31)?"long":"int")+' name="'+p+'" value="'+h+'" />\n';default:return'\n\t<string name="'+p+'"><![CDATA['+h+"]]\x3e</string>\n"}}).join("")+"\n</map>\n",e=this.records.map(function(p){return[].concat(g,l,["Comment"],n,p.times.map(function(h){return',"'+h.header_string+'"'}),p.events.map(function(){return',"Event"'})).join(",")+"\n"+['"'+p.Id+'"','"'+p.Tz+'"'].concat(["start","end","alarm"].map(function(h){h=L.date(p[h],p.Tz);return'"'+L.zero_pad(h.day())+". "+L.zero_pad(h.month())+
". "+h.year()+" "+h.hour()+":"+L.zero_pad(h.minute())+'"'}),l.map(function(h){return'"'+p[h]+'"'}),['"'+p.Comment.string.replace(/"/g,'""').replace(/\n/g," \\n ")+'"','"'+p.Framerate+'"',c(p.Snore,"-1"),c(p.Noise,"-1.0"),c(p.Cycles,"-1"),c(p.DeepSleep,"-1.0"),c(p.LenAdjust,"-1.0"),c(p.Geo,"")],p.times.map(function(h){return'"'+h.actigraphy+'"'}),p.events.map(function(h){return'"'+h.label+"-"+h.timestamp+(h.hasOwnProperty("value")?"-"+h.value:"")+'"'})).join(",")+"\n"+(p.times.length?",,,,,,,,,,,,,"+
p.times.map(function(h){return'"'+h.noise+'"'}).join(",")+"\n":"")}).join("");return P(this,{file_format:function(){return"archive"},contents:{"sleep-export.csv":e,"prefs.xml":d,"alarms.json":a}});case "Standard":return new W({records:this.records.map(function(p){return Object.assign({status:"asleep",start:p.start,end:p.end,start_timezone:p.Tz,end_timezone:p.Tz,tags:p.Comment.tags.map(function(h){return h.value}),comments:p.Comment.notags.length?[p.Comment.notags]:void 0},void 0===p.duration?{}:{duration:p.duration})})},
this.g);default:return L.prototype.to.call(this,a)}};
Z.prototype.to_async=function(a){var b=["Id","Tz","From","To","Sched"],g=["Hours","Rating"],l="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "spreadsheet":a=this.spreadsheet;var n=this.records.length?Math.max.apply(0,this.records.map(function(h){return h.times.length})):0,c=a.get_sheet("Records",b.concat(g,["Comment","Tags"],l),[null,null,"time","time","time",null,null,null,null,null,null,null,null,null,null].concat(Array(n).fill("duration")));n=c[0];c=c[1];var d=
c.cells;d.splice(0);this.records.forEach(function(h){d.push([].concat(b,g,["Comment","Tags"],l,h.times.map(function(k){return(60*k.hours+k.minutes)/1440}),h.events.map(function(){return"Event"})).map(function(k){return V.create_cell(k,"#FFEEEEEE,#FFEEEEEE")}));d.push([h.Id,h.Tz].concat(["start","end","alarm"].map(function(k){return new Date(h[k])}),g.map(function(k){return h[k]}),[h.Comment.notags,h.Comment.tags.map(function(k){return"#"+k.value+(1==k.count?"":"_"+k.count+"x")}).join(" "),h.Framerate,
h.Snore,h.Noise,h.Cycles,h.DeepSleep,h.LenAdjust,h.Geo],h.times.map(function(k){return k.actigraphy}),h.events.map(function(k){return k.label+"-"+k.timestamp+(k.hasOwnProperty("value")?"-"+k.value:"")})).map(function(k){return V.create_cell(k)}));h.times.some(function(k){return k.noise})&&d.push([].concat(Array(13).fill(""),h.times.map(function(k){return k.noise})).map(function(k){return V.create_cell(k)}))});c.cells=d;n&&a.sheets.push(c);c=a.get_sheet("Alarms",["Alarm"],[""]);n=c[0];c=c[1];var e=
c.cells;e.splice(1);this.alarms.forEach(function(h){return e.push([V.create_cell(JSON.stringify(h))])});n&&a.sheets.push(c);c=a.get_sheet("Preferences",["Preferences"],[""]);n=c[0];c=c[1];var p=c.cells;p.splice(1);p.push([V.create_cell(JSON.stringify(this.prefs))]);n&&a.sheets.push(c);return a.serialise();default:return L.prototype.to_async.call(this,a)}};
Z.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(L.unique(this.records,a.records,function(b){return b.Id}));return this};Z.prototype.file_format=function(){return"SleepAsAndroid"};Z.prototype.format_info=function(){return{name:"SleepAsAndroid",title:"Sleep as Android",url:"/src/SleepAsAndroid",statuses:["asleep"],extension:".zip"}};R(Z);function Ba(a,b){b&&(this.g=b);this.spreadsheet=new V(this,[{sheet:"Records",member:"records",cells:[{member:"sid",regexp:/^[1-9][0-9]*$/,type:"number"},{member:"start",type:"time"},{member:"stop",type:"time"},{member:"rating",regexp:/^[0-5]$/,type:"number"}]}]);U(this,a)||(this.records=a.to("Standard").records.filter(function(g){return"asleep"==g.status}).map(function(g,l){return{start:g.start,stop:g.end,sid:l+1,rating:0}}))}J(Ba,L);
Ba.prototype.to=function(a){switch(a){case "output":return P(this,{file_format:function(){return"string"},contents:"sid,start,stop,rating\n"+this.records.map(function(b){return[b.sid,b.start,b.stop,b.rating].join()+"\n"}).join("")});case "Standard":return new W({records:this.records.map(function(b){return{status:"asleep",start:b.start,end:b.stop}})},this.g);default:return L.prototype.to.call(this,a)}};
Ba.prototype.merge=function(a){a=a.to(this.file_format());var b={};this.records.forEach(function(g){return b[g.start+" "+g.stop]=1});this.records=this.records.concat(a.records.filter(function(g){return!b.hasOwnProperty(g.start+" "+g.stop)}));this.records.forEach(function(g,l){return g.sid=l+1});return this};Ba.prototype.file_format=function(){return"PleesTracker"};Ba.prototype.format_info=function(){return{name:"PleesTracker",title:"Plees Tracker",url:"/src/PleesTracker",statuses:["asleep"],extension:".csv"}};
R(Ba);function Ca(a,b){b&&(this.g=b);b=[];this.spreadsheet=new V(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"forced awakening",type:"boolean"},{member:"delayed retirement",type:"boolean"}]}]);switch(a.file_format()){case "array":a=a.contents;if(a.byteLength%12)return T();for(var g=new Float32Array(a),l=new Uint8Array(a),n=1,c=0;c<a.byteLength/12;++c){var d=g[3*c],e=g[3*c+1],p=!l[12*c+8],h=!l[12*c+9];if(d<n||e<=d)return T();n=e;b.push({start:6E4*
Math.round(15776640+1440*d),end:6E4*Math.round(15776640+1440*e),"forced awakening":p,"delayed retirement":h})}break;default:if(U(this,a))return;b=a.to("Standard").records.filter(function(k){return"asleep"==k.status}).map(function(k){return{start:k.start,end:k.end,"forced awakening":(k.tags||[]).some(function(m){return-1!=m.search(/forced awakening/i)}),"delayed retirement":(k.tags||[]).some(function(m){return-1!=m.search(/delayed retirement/i)})}})}this.records=b}J(Ca,L);
Ca.prototype.to=function(a){switch(a){case "output":var b=new Float32Array(3*this.records.length),g=new Uint8Array(b.buffer);this.records.forEach(function(l,n){b[3*n]=(l.start-9465984E5)/864E5;b[3*n+1]=(l.end-9465984E5)/864E5;g[12*n+8]=l["forced awakening"]?0:255;g[12*n+9]=l["delayed retirement"]?0:255});return P(this,{file_format:function(){return"array"},contents:b.buffer});case "Standard":return new W({records:this.records.map(function(l){return{status:"asleep",start:l.start,end:l.end,tags:[].concat(l["forced awakening"]?
["forced awakening"]:[],l["delayed retirement"]?["delayed retirement"]:[])}})},this.g);default:return L.prototype.to.call(this,a)}};Ca.prototype.merge=function(a){function b(l){return["start","end"].map(function(n){return l[n]}).join()}a=a.to(this.file_format());this.records.forEach(function(l){return b(l),1});var g=1;this.records=this.records.concat(a.records).sort(function(l,n){return l.start-n.start}).filter(function(l){if(l.start<g||l.start>=l.end)return!1;g=l.end;return!0});return this};
Ca.prototype.file_format=function(){return"SleepChart1"};Ca.prototype.format_info=function(){return{name:"SleepChart1",title:"SleepChart 1.0",url:"/src/SleepChart1",statuses:["asleep"],extension:".tim"}};R(Ca);function Da(a,b){function g(k){return{type:"text",member:"status",regexp:new RegExp(d.map(function(m){return"("+m[1]+")"}).join("|"),"i"),"export":function(m,q,x){return q[x]=V.create_cell(m[k])},"import":function(m,q,x){return d.some(function(F){return-1!=q[x].value.toString().search(new RegExp(F[1],"i"))&&(m[k]=F[0])})}}}function l(k){return{"export":function(m,q,x){m[k].forEach(function(F){return q[x++]=V.create_cell(F)});return!0},"import":function(m,q,x){for(m=m[k]=e.map(function(){return(q[x++]||
{}).value});m.length&&!m[m.length-1];)m.pop();return!0}}}b&&(this.g=b);var n=[],c={},d=L.status_matches();b={members:[],"export":function(){return!0},"import":function(k){return k.status="asleep"}};var e=[];if("url"==a.file_format()&&"SpreadsheetTable"==a.contents.file_format)c=a.contents.contents.member_map,Object.keys(c).forEach(function(k){var m=c[k];switch(k){case "start":case "end":n[m[1]]={member:m[0],type:"time"};break;case "status":n[m[1]]=Object.assign({members:[m[0]]},g(m[0]));break;case "comments":e=
m[2];1==e.length?n[m[1]]={member:m[0],type:"text"}:n.push(Object.assign({members:e},l(m[0])));break;default:return T()}}),c.status||n.push(b);else if("Standard"==a.file_format())c={start:["start",0],end:["end",1],status:["status",2],comments:["comments",3]},n=[{member:"start",type:"time"},{member:"end",type:"time"},g("status"),{members:["comments"],"export":function(k,m,q){return m[q]=V.create_cell((k.comments||[]).join("; "))},"import":function(k,m,q){m[q].value&&(k.comments=m[q].value.split(/ *; */));
return!0}}];else if(a.sheets&&a.sheets[0]&&a.sheets[0].cells[0]){if(a.sheets[0].cells[0].map(function(k,m){return[k,m]}).filter(function(k){var m=k[0].value;"string"!=typeof m&&(m="");if(![["end",/w.ke|stop|end/i],["start",/sleep|start|begin/i]].some(function(q){if(-1==m.search(q[1]))return!1;c.hasOwnProperty(q[0])||(c[q[0]]=[m,k[1]],n[k[1]]={member:m,type:"time"});return!0}))if(-1!=m.search(/event|activity|stat(e|us)/i))c.hasOwnProperty("status")||(c.status=[m,k[1]],n[k[1]]=Object.assign({members:[m]},
g(m)));else{if(m&&-1==m.search(/comment|note/i))return!0;e.push(k)}return!1}).filter(function(k){var m=k[0].value;if(c.hasOwnProperty("start")){if(c.hasOwnProperty("end"))return!0;c.end=[m,k[1]]}else c.start=[m,k[1]];n[k[1]]={member:m,type:"time"};return!1}).length||!c.hasOwnProperty("start")||!c.hasOwnProperty("end"))return T();for(var p=0;p!=n.length;++p)if(!n[p])return T();if(e.length)if(c.comments=[e[0][0].value,e[0][1],e.map(function(k){return k[0].value})],1==e.length)n[e[0][1]]={member:e[0][0].value,
type:"text"};else{if(e[0][1]!=n.length)return T();for(p=1;p<e.length;++p)if(e[p][1]!=e[p-1][1]+1)return T();n.push(Object.assign({members:e.map(function(k){return k[0].value})},l(e[0][0].value)))}c.hasOwnProperty("status")||n.push(b)}else return T();this.member_map=c;this.spreadsheet=new V(this,[{sheet:"Records",member:"records",cells:n}]);if(!U(this,a)){var h=this.member_map;a=a.to("Standard").records;h.hasOwnProperty("status")||(a=a.filter(function(k){return"asleep"==k.status}));h.hasOwnProperty("comments")&&
(a=a.map(function(k){k.comments&&(k=Object.assign({},k),k.comments=k.comments.map(function(m){return"string"==typeof m?m:m.text}),1==e.length&&(k.comments=k.comments[0]));return k}));this.records=a.map(function(k){var m={};Object.keys(h).forEach(function(q){return m[h[q][0]]=k[q]});return m})}}J(Da,L);
Da.prototype.to=function(a){switch(a){case "output":var b=[],g=[];Object.values(this.member_map).forEach(function(n){g[n[1]]=n[0];n[2]?b=b.concat(n[2]):b[n[1]]=n[0]});return P(this,{file_format:function(){return"string"},contents:b.join()+"\n"+this.records.map(function(n){var c=[];g.forEach(function(d){d=n[d];Array.isArray(d)?c=c.concat(d.map(V.escape_csv_component)):c.push(V.escape_csv_component(d))});return c.join()+"\n"}).join("")});case "Standard":var l=this.member_map;return new W({records:this.records.map(function(n){return{status:n[(l.status||
["status"])[0]],start:n[(l.start||["start"])[0]],end:n[(l.end||["end"])[0]],comments:n[(l.comments||["comments"])[0]]||[]}})},this.g);default:return L.prototype.to.call(this,a)}};
Da.prototype.merge=function(a){function b(n){return["status","start","end"].map(function(c){return n[(g[c]||[c])[0]]}).join()}a=a.to("Standard");var g=this.member_map,l={};this.records.forEach(function(n){return l[b(n)]=1});this.records=this.records.concat(a.records.map(function(n){var c={};Object.keys(g).forEach(function(d){n.hasOwnProperty(d)&&(c[g[d][0]]=n[d])});return c}).filter(function(n){return!l.hasOwnProperty(b(n))}));return this};Da.prototype.file_format=function(){return"SpreadsheetTable"};
Da.prototype.format_info=function(){return{name:"SpreadsheetTable",title:"Spreadsheet Table",url:"/src/SpreadsheetTable",extension:".xlsx"}};R(Da);function Ea(a,b){b&&(this.g=b);var g=L.status_matches(),l={};this.spreadsheet=new V(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"status",type:"text"},{members:["comments"],"export":function(v,y,C){return y[C]=V.create_cell(v.comments.join("; "))},"import":function(v,y,C){return v.comments=y[C].value.split(/\s*;\s*/)}}]}]);if(a.sheets&&a.sheets[0]&&a.sheets[0].cells){var n=a.sheets[0].cells,c=0,d=0,e=n[0].map(function(v){return V.parse_timestamp(v,
a.spreadsheet)});b=n.map(function(v){return V.parse_timestamp(v[0],a.spreadsheet)});var p=Infinity,h=0,k=Infinity,m=0;n.forEach(function(v,y){return v.forEach(function(C,t){C.style&&(p=Math.min(p,t),h=Math.max(h,t),k=Math.min(k,y),m=Math.max(m,y))})});var q=[e,b].map(function(v){for(var y="number"!=typeof v[0]||isNaN(v[0])?[[1]]:[[0,v[0]]],C=1;C<v.length;++C)432E5<=v[C-1]&&432E5>v[C]&&(v[C]+=432E5),"number"!=typeof v[C]||isNaN(v[C])?y.push([C+1]):y[y.length-1].push(v[C]);v=y.sort(function(f,r){return r.length-
f.length})[0];y=v.slice(1);var t;if(4<y.length)y.some(function(f){return 0>f||864E5<=f})?t=1:23<y.length&&(t=2);else{var D=(new Date).getTime();y.length&&y.every(function(f){return 864E5<=f&&f<=D})&&(t=1)}return{lines:1,start:v[0],j:y,type:t}});switch(q[0].type){case 0:q[1].type&&(c=q[1]);break;case 1:switch(q[1].type){case 2:c=q[1];case 0:d=q[0];break;default:q[0].j.length>q[1].j.length?d=q[0]:c=q[1]}break;case 2:switch(q[1].type){case 1:c=q[1];case 0:d=q[0];break;default:q[0].j.length%24<q[1].j.length%
24?d=q[0]:c=q[1]}}if(!d)if((q=c?1:0)?1==c.type:24<=e.length){var x=[];e=e.length-q;e-=e%24;for(var F=0;F!=e;++F)x.push(864E5*F/e);d={lines:0,start:q,j:x,type:2}}else{x=[];e=(new Date).getTime();e-=e%864E5;for(F=Math.max(q+1,p);F<=h;++F)x.push(e-864E5*(h-F));d={lines:0,start:q,j:x,type:2}}if(!c)if(q=d.lines,1==d.type){x=[];b=b.length-q;b-=b%24;for(e=0;e!=b;++e)x.push(864E5*e/b);c={lines:0,start:q,j:x,type:2}}else{b=[];x=(new Date).getTime();x-=x%864E5;for(e=q=Math.max(q,k);e<=m;++e)b.push(x-864E5*
(m-e));c={lines:0,start:q,j:b,type:2}}if(!d.j.length||!c.j.length)return T();var G=[];c.j.forEach(function(v,y){var C=n[c.start+y];d.j.forEach(function(t,D){D=C[d.start+D]||{style:""};G.push({start:v+t,style:D.style||"",comments:D.value?[D.value]:[]})})});if(!G.length)return T();G=G.sort(function(v,y){return v.start-y.start});var H=[{style:NaN}];G.forEach(function(v){v.style==H[H.length-1].style?H[H.length-1].comments=H[H.length-1].comments.concat(v.comments):(H[H.length-1].end=v.start-1,H.push(v))});
H.shift();var M={};H.forEach(function(v){var y=M[v.style]=M[v.style]||{u:[],duration:0};y.u.push(v);v.end&&v.start&&(y.duration+=v.end-v.start)});var O=[],Y=[];n.forEach(function(v,y){v.forEach(function(C,t){if(y<c.start-d.lines||y>=c.start+c.j.length||t<d.start-c.lines||t>=d.start+d.j.length)C.value&&Y.push([y,t,C.value]),C.style&&O.push([y,t,C.style])})});var Q=[];O.forEach(function(v){return Q=Q.concat(Y.map(function(y){return[Math.abs(y[0]-v[0])+Math.abs(y[1]-v[1]),v[2],y[2]]}))});var N={};g.forEach(function(v){return N[v[0]]=
new RegExp(v[1],"i")});var X={};Q.sort(function(v,y){return v[0]-y[0]}).forEach(function(v){if(M[v[1]]&&!X[v[2]]){X[v[2]]=1;var y=Object.keys(N).find(function(C){return-1!=v[2].search(N[C])});y?delete N[y]:y=v[2];l[y]=v[1];M[v[1]].u.forEach(function(C){delete C.style;C.status=y});delete M[v[1]]}});var S=0;Object.values(M).sort(function(v,y){return y.duration-v.duration}).forEach(function(v){var y=g.find(function(C){return N[C[0]]});y?(y=y[0],delete N[y]):y="Unknown status #"+ ++S;v.u.forEach(function(C){l[y]=
C.style;C.status=y;delete C.style})})}else{if(U(this,a))return;H=a.to("Standard").records.map(function(v){var y={comments:[]};["start","end","status","comments"].forEach(function(C){return v.hasOwnProperty(C)&&(y[C]=v[C])});l[v.status]=g.find(function(C){return C[0]==v.status})[2];return y})}this.records=H;this.status_map=l}J(Ea,L);
Ea.prototype.to=function(a){switch(a){case "output":throw Error("Please use to_async() to generate output for SpreadsheetGraph");case "Standard":return new W({records:this.records},this.g);default:return L.prototype.to.call(this,a)}};
Ea.prototype.to_async=function(a){var b=this;switch(a){case "output":var g=this.records,l=this.status_map,n=[60,30,15,5].map(function(m){return 6E4*m}).find(function(m){return!g.filter(function(q){return q.start%m}).length})||3E5,c=Infinity,d=0;g.forEach(function(m){c=Math.min(c,m.start);d=Math.max(d,m.start)});Infinity==c&&(c=d);c-=c%864E5;d-=d%864E5;var e=[[V.create_cell()]];a=["YYYY-MM-DD"];for(var p=[11.5],h=0;864E5!=h;h+=n)e[0].push(V.create_cell(new Date(h),"#FFEEEEEE,#FFEEEEEE")),a.push("H:MM"),
p.push(5.9);for(h=c;h<=d;h+=864E5)e.push([V.create_cell(new Date(h),"#FFEEEEEE,#FFEEEEEE")]);g.forEach(function(m){var q=m.start,x=m.end||q+1,F=l[m.status];m=(m.comments||[]).slice(0);for(var G=Math.ceil(m.length/Math.max((x-q)/n));q<x;q+=n){var H=q%864E5;e[(q-H-c)/864E5+1][Math.floor(H/n)+1]=V.create_cell(m.splice(0,G).join("; "),F)}});var k={};g.forEach(function(m){var q=m.status;l[q]&&((k[q]=k[q]||[0,l[q],q])[0]+=m.end-m.start)});Object.values(k).sort(function(m,q){return q[0]-m[0]}).forEach(function(m,
q){q=e[q+1]=e[q+1]||[];q[e[0].length+2]=V.create_cell(void 0,m[1]);q[e[0].length+3]=V.create_cell(m[2])});this.spreadsheet.sheets[0]={name:"Sleep Graph",number_formats:a,cells:e,widths:p};return this.spreadsheet.serialise().then(function(m){return P(b,{file_format:function(){return"array"},contents:m})});default:return L.prototype.to_async.call(this,a)}};
Ea.prototype.merge=function(a){function b(c){return["status","start","end"].map(function(d){return c[d]}).join()}a=a.to(this.file_format());var g={};this.records.forEach(function(c){return g[b(c)]=1});this.records=this.records.concat(a.records.filter(function(c){return!g.hasOwnProperty(b(c))}));var l=a.status_map,n=this.status_map;Object.keys(l).forEach(function(c){n.hasOwnProperty(c)||(n[c]=l[c])});return this};Ea.prototype.file_format=function(){return"SpreadsheetGraph"};
Ea.prototype.format_info=function(){return{name:"SpreadsheetGraph",title:"Spreadsheet Graph",url:"/src/SpreadsheetGraph",extension:".xlsx"}};R(Ea);}).call(this);
//# sourceMappingURL=sleep-diary-formats.js.map
